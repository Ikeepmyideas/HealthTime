{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper container">
    
    <aside class="dashboard-sidebar">
        <div class="profile-section">
            <div class="profile-avatar" style="background-color: #e3f2fd; color: #2e7d32;">|ü©∫|</div>
            <h3>Dr. {{ user.name }}</h3>
            <p>Espace Praticien</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="?tab=dashboard" class="{% if tab == 'dashboard' %}active{% endif %}">üìä Accueil</a>
            <a href="?tab=calendar_planner" class="{% if tab == 'calendar_planner' %}active{% endif %}">üìÖ Cr√©er des disponibilit√©s</a>
            <a href="?tab=weekly_planner" class="{% if tab == 'weekly_planner' %}active{% endif %}">üìÜ Mon Semainier</a>
            <a href="/logout" class="logout-link"> Se d√©connecter</a>
        </nav>
    </aside>

    <main class="dashboard-content">
        {% if upcoming_appts %}
            <div class="notifications-container" style="margin-bottom: 25px;">
                {% for appt in upcoming_appts %}
                    <div class="alert-reminder" style="background-color: #fff3cd; color: #856404; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #ffc107; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px;">
                        <div>
                            <span style="font-size: 1.2rem; margin-right: 10px;">‚è∞</span>
                            <strong>Rappel imminent :</strong> 
                            Vous avez une consultation le <b>{{ appt.date }} √† {{ appt.time }}</b> avec <b>{{ appt.contact_name }}</b>.
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if tab == 'dashboard' %}
        <div class="dashboard-header welcome-card" style="border-left-color: #4CAF50;">
            <h2>Bienvenue, <span>Dr. {{ user.name.split(' ')[0] }}</span></h2>
            <p>G√©rez vos disponibilit√©s et vos consultations depuis votre espace professionnel.</p>
        </div>
        {% endif %}

        {% if tab == 'calendar_planner' %}
        <div class="welcome-card" style="text-align: left; max-width: 800px; margin: 0 auto;">
            <h2 style="font-family: 'Playfair Display'; color: #4a4244;">Cr√©er des <span>Disponibilit√©s</span></h2>
            <p style="color: #8a8183; margin-bottom: 30px;">S√©lectionnez un mois, cochez les jours travaill√©s, puis cochez vos horaires d'ouverture.</p>
            
            <form action="/doctor_dashboard" method="GET" style="display: flex; gap: 15px; margin-bottom: 20px;">
                <input type="hidden" name="tab" value="calendar_planner">
                <select name="month" class="search-input" style="border: 1px solid #e0d5d7!important; padding: 8px; border-radius: 8px;" onchange="this.form.submit()">
                    {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if month == m %}selected{% endif %}>Mois {{ m }}</option>
                    {% endfor %}
                </select>
                <select name="year" class="search-input" style="border: 1px solid #e0d5d7!important; padding: 8px; border-radius: 8px;" onchange="this.form.submit()">
                    {% for y in range(2024, 2035) %}
                        <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </form>

            <form action="/doctor_create_slots" method="POST">
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="month" value="{{ month }}">
                
                <table class="weekly-calendar" style="margin-bottom: 30px;">
                    <thead>
                        <tr>
                            <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in cal %}
                        <tr>
                            {% for day in week %}
                                <td style="padding: 0;">
                                    {% if day != 0 %}
                                        <input type="checkbox" name="days" value="{{ day }}" id="day_{{ day }}" class="hidden-checkbox">
                                        <label for="day_{{ day }}" class="day-label">{{ day }}</label>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h3 style="font-size: 1.2rem; color: #6d6875;">S√©lectionnez les heures :</h3>
                <div class="slots-grid" style="margin-bottom: 30px;">
                    {% for hour in range(7, 23) %}
                        <input type="checkbox" name="hours" value="{{ hour }}" id="hour_{{ hour }}" class="hidden-checkbox">
                        <label for="hour_{{ hour }}" class="slot-label">{{ hour }}:00</label>
                    {% endfor %}
                </div>

                <button type="submit" class="btn" style="background-color: #4CAF50; width: 100%;">Enregistrer les disponibilit√©s</button>
            </form>
        </div>
        {% endif %}

        {% if tab == 'weekly_planner' %}
        <div class="welcome-card" style="padding: 30px;">
            <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <a href="?tab=weekly_planner&week_offset={{ week_offset - 1 }}" class="btn btn-outline" style="padding: 5px 15px;">‚¨Ö</a>
                <h2 style="margin: 0; font-family: 'Playfair Display'; color: #4CAF50;">Mon Semainier</h2>
                <a href="?tab=weekly_planner&week_offset={{ week_offset + 1 }}" class="btn btn-outline" style="padding: 5px 15px;">‚û°</a>
            </div>
            
            <p style="text-align: center; color: #8a8183; margin-bottom: 20px;">Semaine du {{ week_dates[0].strftime('%d/%m') }}</p>

            <table class="weekly-calendar">
                <thead>
                    <tr>
                        <th>Heure</th>
                        {% for d in week_dates %}
                            <th>{{ d.strftime('%a') }}<br>{{ d.strftime('%d %b') }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for hour in range(7, 23) %}
                    <tr>
                        <td class="time-cell">{{ "%02d:00" | format(hour) }}</td>
                        {% for d in week_dates %}
                            {% set key = d.strftime('%Y-%m-%d') ~ '-' ~ hour %}
                            
                            {% if key in appt_map %}
                                {# Si un RDV existe (annul√© ou non), il est prioritaire sur l'affichage du cr√©neau vide #}
                                {% set appt = appt_map[key] %}
                                <td class="appt-cell js-doc-appt 
                                    {% if appt.is_canceled %}doc-canceled
                                    {% elif appt.is_urgent %}doc-urgent
                                    {% else %}doc-booked{% endif %}" 
                                    data-id="{{ appt.id }}"
                                    data-patient="{{ appt.patient_name }}"
                                    data-email="{{ appt.patient_email }}"
                                    data-phone="{{ appt.patient_phone }}"
                                    data-date="{{ appt.date_str }}"
                                    data-time="{{ appt.time_short }}"
                                    data-status="{{ 'Annul√©' if appt.is_canceled else 'Confirm√©' }}"
                                    data-urgent="{{ 'Oui' if appt.is_urgent else 'Non' }}"
                                    data-cancelable="{{ 'true' if appt.is_cancelable else 'false' }}">
                                    {{ appt.patient_name.split(' ')[0] }} {% if appt.is_urgent and not appt.is_canceled %}‚ö°{% endif %}
                                </td>
                            {% elif key in slot_map and slot_map[key] == 'available' %}
                                <td class="appt-cell doc-available js-toggle-slot" 
                                    data-date="{{ d.strftime('%Y-%m-%d') }}" 
                                    data-hour="{{ hour }}" 
                                    style="cursor: pointer;" title="Cliquez pour retirer ce cr√©neau">Libre</td>
                            {% else %}
                                <td class="empty-cell js-toggle-slot" 
                                    data-date="{{ d.strftime('%Y-%m-%d') }}" 
                                    data-hour="{{ hour }}" 
                                    style="background-color: #fcfcfc; cursor: pointer;" title="Cliquez pour ajouter un cr√©neau"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #e0d5d7; display: flex; gap: 20px; font-size: 0.9rem; color: #6d6875;">
                <span style="font-weight: bold;">L√©gende :</span>
                <span><span style="color: #2ecc71;">üü¢</span> Disponible</span>
                <span><span style="color: #e74c3c;">üî¥</span> R√©serv√©</span>
                <span><span style="color: #f1c40f;">üü°</span> Urgent</span>
                <span><span style="color: #95a5a6;">‚ö™</span> Annul√©</span>
            </div>
        </div>
        {% endif %}

    </main>
</div>

<!-- MODALE DOC -->
<div id="docModal" class="modal-overlay">
    <div class="modal-content welcome-card" style="border-top-color: #4CAF50;">
        <span class="close-modal" onclick="closeDocModal()">&times;</span>
        <h3 style="font-family: 'Playfair Display'; color: #4a4244; margin-bottom: 20px;">
            D√©tails du Rendez-vous
        </h3>

        <div style="line-height: 1.8;">
            <p><strong>Patient :</strong> <span id="docModalPatient" style="color: #4CAF50; font-weight: bold;"></span></p>
            <p><strong>Email :</strong> <span id="docModalEmail"></span></p>
            <p><strong>T√©l√©phone :</strong> <span id="docModalPhone"></span></p>
            <p><strong>Date :</strong> <span id="docModalDate"></span> √† <span id="docModalTime"></span></p>
            <p><strong>Urgent :</strong> <span id="docModalUrgent" style="font-weight: bold;"></span></p>
            <p><strong>Statut :</strong> <span id="docModalStatus" class="badge"></span></p>

            <div id="docCancelContainer" style="margin-top:25px; display:none;">
                <form id="docCancelForm" method="POST" onsubmit="return confirm('Annuler cette consultation ?');">
                    <button type="submit" class="btn btn-cancel" style="width:100%;">
                        Annuler cette consultation
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('docModal');
    const apptCells = document.querySelectorAll('.js-doc-appt'); 

    function openModal() {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    window.closeDocModal = function() {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    // Gestion du toggle des cr√©neaux
    document.querySelectorAll('.js-toggle-slot').forEach(function(cell) {
        cell.addEventListener('click', function() {
            const date = this.dataset.date;
            const hour = this.dataset.hour;
            fetch('/api/toggle_slot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ date: date, hour: hour })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") window.location.reload();
            });
        });
    });

    // Gestion de l'affichage des d√©tails du RDV
    apptCells.forEach(function(cell) {
        cell.addEventListener('click', function() {
            document.getElementById("docModalPatient").innerText = this.dataset.patient;
            document.getElementById("docModalEmail").innerText = this.dataset.email;
            document.getElementById("docModalPhone").innerText = this.dataset.phone;
            document.getElementById("docModalDate").innerText = this.dataset.date;
            document.getElementById("docModalTime").innerText = this.dataset.time;
            document.getElementById("docModalUrgent").innerText = this.dataset.urgent;

            const status = this.dataset.status;
            const statusEl = document.getElementById("docModalStatus");
            statusEl.innerText = status;
            statusEl.className = status === "Annul√©" ? "badge badge-red" : "badge badge-green";

            const cancelContainer = document.getElementById("docCancelContainer");
            if (this.dataset.cancelable === 'true') {
                cancelContainer.style.display = "block";
                document.getElementById("docCancelForm").action = "/doctor_cancel_appt/" + this.dataset.id;
            } else {
                cancelContainer.style.display = "none";
            }

            openModal();
        });
    });

    window.onclick = function(event) { if (event.target == modal) closeDocModal(); }
});
</script>

<style>
.hidden-checkbox { display: none; }
.day-label { display: block; width: 100%; padding: 15px 0; text-align: center; cursor: pointer; background-color: white; transition: 0.2s; }
.slot-label { padding: 10px 15px; border-radius: 8px; border: 1px solid #e0d5d7; cursor: pointer; background-color: white; color: #6d6875; font-weight: 500; transition: 0.2s; }
.hidden-checkbox:checked + .day-label, .hidden-checkbox:checked + .slot-label { background-color: #4CAF50; color: white; border-color: #4CAF50; }

.doc-available { background-color: #2ecc71 !important; color: white; }
.doc-booked { background-color: #e74c3c !important; color: white; cursor: pointer; }
.doc-urgent { background-color: #f1c40f !important; color: #333 !important; cursor: pointer; border: 2px solid #f39c12; font-weight: bold; }
.doc-canceled { background-color: #95a5a6 !important; color: white; cursor: pointer; opacity: 0.8; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.55); display: none; justify-content: center; align-items: center; z-index: 9999; }
.modal-content { position: relative; max-width: 450px; width: 90%; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 25px 70px rgba(0,0,0,0.3); animation: fadeInDoc 0.25s ease; }
@keyframes fadeInDoc { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
.close-modal { position: absolute; top: 15px; right: 20px; font-size: 26px; cursor: pointer; color: #999; transition: 0.2s; }
.close-modal:hover { color: #000; }
.btn-cancel { background-color: white; color: #d9534f; border: 1px solid #d9534f; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.btn-cancel:hover { background-color: #fdf3f4; }
body.modal-open { overflow: hidden; }
</style>
{% endblock %}
