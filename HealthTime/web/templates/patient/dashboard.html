{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper container">
    
    <aside class="dashboard-sidebar">
        <div class="profile-section">
            <div class="profile-avatar">üå∏</div>
            <h3>{{ user.name }}</h3>
            <p>Espace Patient</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="?tab=dashboard" class="{% if tab == 'dashboard' or not tab %}active{% endif %}">üìä Mes rendez-vous</a>
            <a href="?tab=booking" class="{% if tab == 'booking' %}active{% endif %}">üìÖ Prendre un RDV</a>
            <a href="?tab=calendar" class="{% if tab == 'calendar' %}active{% endif %}">üìÜ Mon Semainier</a>
            <a href="/logout" class="logout-link"> Se d√©connecter</a>
        </nav>
    </aside>

    <main class="dashboard-content">
        <!-- RAPPELS DE RDV -->
        {% if upcoming_alerts %}
            <div class="notifications-container" style="margin-bottom: 25px;">
                {% for appt in upcoming_alerts %}
                    <div class="alert-reminder" style="background-color: #fff3cd; color: #856404; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #ffc107; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px;">
                        <div>
                            <span style="font-size: 1.2rem; margin-right: 10px;">üîî</span>
                            <strong>Rappel :</strong> Demain √† {{ appt.time }} avec le <b>Dr. {{ appt.contact_name }}</b>.
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- ONGLET DASHBOARD -->
        {% if tab == 'dashboard' or not tab %}
        <div class="dashboard-header welcome-card">
            <h2>Bonjour, <span>{{ user.name.split(' ')[0] }}</span></h2>
            <p>Voici l'√©tat de vos rendez-vous m√©dicaux.</p>
        </div>

        <section class="appointments-section">
            <h3 class="section-subtitle">√Ä venir</h3>
            {% if upcoming %}
                <div class="appointments-list">
                    {% for appt in upcoming %}
                        <div class="appointment-card {% if appt.is_canceled %}canceled{% else %}upcoming{% endif %}" 
                             style="{% if appt.urgent %}border-left: 5px solid #d32f2f;{% endif %}">
                            <div class="appt-info">
                                <h4>Dr. {{ appt.doctor_name }} {% if appt.urgent %}<span style="color: #d32f2f;">‚ö° [URGENT]</span>{% endif %}</h4>
                                <p class="appt-datetime">üóìÔ∏è {{ appt.date }} √† üïí {{ appt.time[:5] }}</p>
                            </div>
                            <div class="appt-actions" style="display: flex; gap: 10px; align-items: center;">
                                {% if appt.is_canceled %}
                                    <span class="badge badge-red">Annul√©</span>
                                {% else %}
                                    <span class="badge badge-green">Confirm√©</span>
                                    <form action="/cancel_appointment/{{ appt.id }}" method="POST" onsubmit="return confirm('Annuler ce rendez-vous ?');" style="margin: 0;">
                                        <button type="submit" class="btn btn-cancel btn-sm">Annuler</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state"><p>Aucun rendez-vous √† venir.</p></div>
            {% endif %}

            <h3 class="section-subtitle" style="margin-top: 40px;">Historique</h3>
            {% if past %}
                <div class="appointments-list">
                    {% for appt in past %}
                        <div class="appointment-card past">
                            <div class="appt-info">
                                <h4>Dr. {{ appt.doctor_name }}</h4>
                                <p class="appt-datetime">üóìÔ∏è {{ appt.date }} √† {{ appt.time[:5] }}</p>
                            </div>
                            <span class="badge badge-gray">Termin√©</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </section>

        {% elif tab == 'booking' %}
        <div class="welcome-card" style="text-align: left;">
            <h2 style="color: #4CAF50;">üìÖ Prendre un <span>Rendez-vous</span></h2>
            
            <form action="/patient_dashboard" method="GET" class="booking-form" style="display: grid; gap: 20px; margin-top: 20px;">
                <input type="hidden" name="tab" value="booking">
                
                <div class="input-group">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">1. Sp√©cialit√© recherch√©e</label>
                    <select name="specialty_id" onchange="this.form.submit()" class="search-input" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">-- S√©lectionnez une sp√©cialit√© --</option>
                        {% for spec in specialties %}
                            <option value="{{ spec.id }}" {% if selected_specialty|string == spec.id|string %}selected{% endif %}>{{ spec.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {% if selected_specialty %}
                <div class="input-group">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">2. M√©decin</label>
                    <select name="doctor_id" class="search-input" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="any" {% if selected_doctor == 'any' %}selected{% endif %}>Peu importe (Premier disponible)</option>
                        {% for doc in filtered_doctors %}
                            <option value="{{ doc.id }}" {% if selected_doctor|string == doc.id|string %}selected{% endif %}>Dr. {{ doc.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">3. Date</label>
                    <input type="date" name="date" value="{{ selected_date }}" 
                           min="{{ now.strftime('%Y-%m-%d') }}" 
                           required class="search-input" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                </div>

                <!-- √âtape 4 : Urgence -->
                <div style="background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px solid #fed7d7;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #c53030; font-weight: bold;">
                        <input type="checkbox" name="urgent" style="width: 18px; height: 18px;">
                        ‚ö° Signaler comme rendez-vous URGENT
                    </label>
                    <p style="font-size: 0.85rem; color: #742a2a; margin: 5px 0 0 28px;">Le m√©decin verra une alerte prioritaire pour ce RDV.</p>
                </div>

                <button type="submit" class="btn" style="background-color: #4CAF50; padding: 15px;">üîç Rechercher des cr√©neaux</button>
                {% endif %}
            </form>

            <!-- Affichage des cr√©neaux -->
            {% if slots %}
                <div class="slots-container" style="margin-top: 30px;">
                    <h3 style="font-size: 1.1rem; color: #333; margin-bottom: 15px;">Cr√©neaux disponibles le {{ selected_date }} :</h3>
                    <div class="slots-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                        {% for slot in slots %}
                            {% set slot_time = slot.time if slot is mapping else slot %}
                            {% set slot_doc_id = slot.doctor_id if slot is mapping else selected_doctor %}
                            {% set slot_doc_name = slot.doctor_name if slot is mapping else '' %}

                            {# Filtrage temps r√©el pour aujourd'hui #}
                            {% if selected_date != now.strftime('%Y-%m-%d') or slot_time > now.strftime('%H:%M') %}
                                <form action="/book_appointment" method="POST" style="margin: 0;">
                                    <input type="hidden" name="doc_id" value="{{ slot_doc_id }}">
                                    <input type="hidden" name="date" value="{{ selected_date }}">
                                    <input type="hidden" name="time" value="{{ slot_time }}">
                                    <input type="hidden" name="urgent" class="urgent-sync-input">
                                    <button type="submit" class="slot-btn" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #4CAF50; background: white; color: #4CAF50; cursor: pointer; transition: 0.2s;">
                                        <b>{{ slot_time }}</b>
                                        {% if slot_doc_name %}<br><small>Dr. {{ slot_doc_name.split(' ')[0] }}</small>{% endif %}
                                    </button>
                                </form>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% elif selected_date %}
                <p style="margin-top: 20px; color: #d32f2f; text-align: center;">D√©sol√©, aucun cr√©neau n'est disponible pour cette s√©lection.</p>
            {% endif %}
        </div>

        <!-- ONGLET CALENDRIER -->
        {% elif tab == 'calendar' %}
        <div class="welcome-card" style="padding: 30px;">
            <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <a href="?tab=calendar&week_offset={{ week_offset - 1 }}" class="btn btn-outline" style="padding: 5px 15px;">‚¨Ö</a>
                <h2 style="margin: 0; font-family: 'Playfair Display'; color: #2196F3;">Mon Semainier</h2>
                <a href="?tab=calendar&week_offset={{ week_offset + 1 }}" class="btn btn-outline" style="padding: 5px 15px;">‚û°</a>
            </div>
            
            <p style="text-align: center; color: #8a8183; margin-bottom: 20px;">
                Semaine du {{ week_dates[0].strftime('%d/%m') }} au {{ week_dates[-1].strftime('%d/%m') }}
            </p>
            
            <table class="weekly-calendar">
                <thead>
                    <tr>
                        <th>Heure</th>
                        {% for d in week_dates %}
                            <th>{{ d.strftime('%a') }}<br>{{ d.strftime('%d %b') }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for hour in range(8, 19) %}
                    <tr>
                        <td class="time-cell">{{ "%02d:00" | format(hour) }}</td>
                        {% for d in week_dates %}
                            {% set key = (d, hour) %}
                            {% if key in appt_map %}
                                {% set appt = appt_map[key] %}
                                {% set spec = appt.specialty | default('G√©n√©raliste', true) %}
                                {% set indic = appt.indications | default("Merci de vous pr√©senter 10 min en avance avec votre carte vitale. En cas d'emp√™chement, merci d'annuler au moins 24h √† l'avance.", true) %}
                                
                                <td class="appt-cell js-appt-cell {% if appt.is_canceled %}canceled{% else %}active{% endif %}"
                                    style="{% if appt.urgent and not appt.is_canceled %}background-color: #fff5f5; border: 1px solid #feb2b2; color: #c53030;{% endif %}"
                                    data-id="{{ appt.id }}"
                                    data-doc="{{ appt.doctor_name }}"
                                    data-spec="{{ spec }}"
                                    data-date="{{ appt.date }}"
                                    data-time="{{ appt.time_short }}"
                                    data-urgent="{{ 'Oui' if appt.urgent else 'Non' }}"
                                    data-status="{{ 'Annul√©' if appt.is_canceled else 'Confirm√©' }}"
                                    data-indic="{{ indic }}"
                                    data-future="{{ 'true' if not appt.is_canceled and appt.date >= now.strftime('%Y-%m-%d') else 'false' }}">
                                    Dr. {{ appt.doctor_name.split(' ')[0] }} {% if appt.urgent %}‚ö°{% endif %}
                                </td>
                            {% else %}
                                <td class="empty-cell"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </main>
</div>

<!-- MODAL DETAILS RDV (RESTAUR√â) -->
<div id="apptModal" class="modal-overlay">
    <div class="modal-content welcome-card">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 style="font-family: 'Playfair Display', serif; color: #2196F3; margin-top: 0; margin-bottom: 20px;">D√©tails du Rendez-vous</h3>
        
        <div style="font-size: 1.05rem; color: #6d6875; line-height: 1.8;">
            <p style="margin: 5px 0;">
                <strong>Praticien :</strong> Dr. <span id="modalDoc"></span> 
                <span id="modalSpec" style="font-size: 0.9em; color: #2196F3; font-style: italic;"></span>
            </p>
            <p style="margin: 5px 0;"><strong>Date :</strong> <span id="modalDate"></span> √† <span id="modalTime"></span></p>
            <p style="margin: 5px 0;"><strong>Urgent :</strong> <span id="modalUrgent"></span></p>
            <p style="margin: 5px 0;"><strong>Statut :</strong> <span id="modalStatus"></span></p>
            
            <div style="margin-top: 20px; padding: 15px; background-color: #fcf9f9; border-radius: 10px; border-left: 4px solid #2196F3;">
                <h4 style="margin: 0 0 10px 0; color: #4a4244; font-size: 1rem;">Indications du cabinet :</h4>
                <p id="modalIndications" style="margin: 0; font-size: 0.95rem;"></p>
            </div>

            <div id="modalCancelContainer" style="margin-top: 20px; text-align: center; display: none;">
                <form id="modalCancelForm" method="POST" onsubmit="return confirm('√ätes-vous s√ªr(e) de vouloir annuler ce rendez-vous ?');">
                    <button type="submit" class="btn btn-cancel" style="width: 100%;">Annuler ce rendez-vous</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.querySelector('input[name="urgent"]')?.addEventListener('change', function() {
    const isChecked = this.checked ? "on" : "";
    document.querySelectorAll('.urgent-sync-input').forEach(input => {
        input.value = isChecked;
    });
});

const modal = document.getElementById('apptModal');

function openModal() { 
    modal.style.display = 'flex'; 
    document.body.classList.add('modal-open');
}

function closeModal() { 
    modal.style.display = 'none'; 
    document.body.classList.remove('modal-open');
}

document.querySelectorAll('.js-appt-cell').forEach(cell => {
    cell.addEventListener('click', function() {
        document.getElementById('modalDoc').innerText = this.dataset.doc;
        document.getElementById('modalSpec').innerText = "- " + this.dataset.spec;
        document.getElementById('modalDate').innerText = this.dataset.date;
        document.getElementById('modalTime').innerText = this.dataset.time;
        document.getElementById('modalUrgent').innerText = this.dataset.urgent;
        document.getElementById('modalIndications').innerText = this.dataset.indic;

        const statusSpan = document.getElementById('modalStatus');
        const status = this.dataset.status;
        statusSpan.innerText = status;
        
        if(status.toLowerCase().includes('annul√©')) {
            statusSpan.className = "badge badge-red";
        } else {
            statusSpan.className = "badge badge-green";
        }

        const cancelContainer = document.getElementById('modalCancelContainer');
        const cancelForm = document.getElementById('modalCancelForm');
        const isFuture = this.dataset.future === 'true';
        
        if (isFuture) {
            cancelContainer.style.display = 'block';
            cancelForm.action = "/cancel_appointment/" + this.dataset.id;
        } else {
            cancelContainer.style.display = 'none';
        }

        openModal();
    });
});

window.onclick = function(event) {
    if (event.target == modal) closeModal();
}

document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") closeModal();
});
</script>

<style>
.slot-btn:hover { background: #4CAF50 !important; color: white !important; }
.badge-red { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
.badge-green { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
.badge-gray { background: #f3f4f6; color: #374151; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }

/* Modal Styles Restaur√©s */
.modal-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.5); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 1000; 
}

.modal-content { 
    position: relative;
    max-width: 450px; 
    width: 90%;
    background: white; 
    padding: 30px; 
    border-radius: 20px; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.2); 
    animation: fadeIn 0.25s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-15px); }
    to { opacity: 1; transform: translateY(0); }
}

.close-modal { 
    position: absolute; 
    right: 20px; 
    top: 15px; 
    cursor: pointer; 
    font-size: 26px; 
    color: #8a8183;
}

.close-modal:hover { color: #d32f2f; }

.btn-cancel {
    background-color: white;
    color: #d9534f;
    border: 1px solid #d9534f;
    padding: 10px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-cancel:hover {
    background-color: #fdf3f4;
    color: #c9302c;
}

body.modal-open { overflow: hidden; }
</style>
{% endblock %}
